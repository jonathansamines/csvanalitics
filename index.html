<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CSV Analitics</title>
    
    <!-- Stylesheets -->
    <link rel='stylesheet' href='http://cdnjs.cloudflare.com/ajax/libs/normalize/3.0.1/normalize.min.css' />
    
    <!-- Application layout styles -->    
    <style>
        html, body{
            background-color : #f8f8f8;
            font-size : 16px;
            color : #303030;
        }
        a{ color : #0162A3; text-decoration : none; }
        h1, h2, h3, h4, h5, h6, ul { margin : 0; }
        input[type='file']{ font-size : .8em; }
        select{ 
            margin : .5em 1em; 
            padding : .2em .8em;
            border : 1px solid #ccc;
        }
        
        /* layout components */
        .container{
            display : blocK;
            max-width : 55em;
            overflow : hidden;
        }
        .center{
            margin-left : auto;
            margin-right : auto;
        }
        
        .round{
            -webkit-border-radius : 2px 2px;
               -moz-border-radius : 2px 2px;
                 -o-border-radius : 2px 2px;
                -ms-border-radius : 2px 2px;
                    border-radius : 2px 2px;
        }
        
        .right{
            float : right;
        }
        .left{
            float: left;
        }
        
        /* toolbar component */
        .toolbar{
            width : auto;
            padding : .7em 1em;
            background-color : #fafafa;
            overflow: hidden;
        }
        
        /* button component */
        .button{
            display: inline-block;
            border : none;
            padding : .4em .8em;
            
            -webkit-transition : 1s all ease-out;
        }
        .button.green{
            color : #fafafa;
            background-color : #90A959;
        }
        .button.green:hover, .button.green:focus{
            background-color : #799514;
        }
        
        /* label component */
        .label{
            display : inline-block;
            padding : .2em .5em;
        }
            .label.yellow{
                color : #fafafa;
                background-color : #F7CA87;
            }
        
        /*  table component */
        .table{ text-align : center; color : #505050; width : 95%; }

            .table caption{
                padding : .5em 1em;
                font-weight : bold;
                text-align : left;
                border-bottom : 1px solid #7DAFC2;
            }
    
            .table thead{
                background-color : #fff;
                border-bottom : 1px solid #e0e0e0;
                font-size : .9rem;
            }
            .table thead th{
                padding : 1em 1.4em;
                text-align : center;
            }
            .table.sorted thead th{}
                
                .table tbody{}
                    .table tbody{ font-size : .8em;  }
                    .table tbody td{
                        padding : .6em 1em;
                    }
        
        /* application styles */
        header{
            background-color : #0162A3;
            margin-top : 1em;
            padding : .5em 2.5em;
            -webkit-box-shadow : 2px 2px 3px #ccc;
        }
        header h1 a{ color : #fafafa; }
        header h4{ color : #ccc; }
        
        #application{
            background-color : #fff;
            margin-bottom : 3em;
            min-height : 800px;
            padding : 1em 1.5em 2.5em 1.5em;
            -webkit-box-shadow : 2px 2px 5px #eee;
        }
        
    </style>
    
</head>
<body>
    
    <!-- Application layout -->
    <header class='container center'>
        <h1>
            <a href='#' title='CSV Analitics'>CSV Analitics</a>
        </h1>
        <h4>CSV Analitics make easy!</h4>
    </header>
    
    <section id='application' class='container center'>
        <div class='toolbar center'>
            <input id='textFileSelection' type='file'>
            <button id='buttonProcessFile' class='button round green right'>Process File</button>
        </div>
        <div class="content">
            <table id='tableGridData' class='table sorted center'></table>
        </div>
    </section>
    
    <script src='https://code.jquery.com/jquery-1.11.1.js'></script>
    <script type='text/javascript'>
        
        $(document).on('ready', function(){
            var application = new ApplicationView();
            application.init();
        });
        
        // ApplicationView
        // main view of application state
        var ApplicationView = function(){
            
            // init view components
            this.$buttonProcessFile = $('#buttonProcessFile');
            this.$textFileSelection = $('#textFileSelection');
            this.$tableGridData = $('#tableGridData');
        };
        
        ApplicationView.prototype.processFile = function(){
            var self = this,
                selector = new FileSelector(self.$textFileSelection[0]),
                result = selector.readFileContent();

            result.done(function(data){
                var analizer = new CsvAnalizer(data),
                    source = analizer.getContentAsGrid(),
                    table = new TableView(selector.getSelectedFile().name, self.$tableGridData);
                
                table.bind(source, analizer.headers, function(column){
                    return column.toLowerCase() === "quetsol";
                });
            });

            result.fail(function(error){
                console.log(error);
            });
        };
        
        ApplicationView.prototype.init = function(){
            var self = this;
            
            this.$buttonProcessFile.on('click', function(e){
                e.preventDefault();
                e.stopImmediatePropagation();
                
                // process file action
                self.processFile();
            });
        };
        
        
        // TableView
        // Allow to create a view of table, from grid source
        // <param name='title'>Title of table, used for caption tag</param>
        // <param name='table'>Table element</param>
        var TableView = function(title, table){
            this.$table = table;
            this.title = title;
            
            this.createSortOptions();
        };
        
        TableView.prototype.createSortOptions = function(){
             var sortMode = 'DESC', self = this;
            
            // create sort options
            this.$table.on('click', '[data-sort-column]', function(e){
                e.preventDefault();
                e.stopImmediatePropagation();
                
                self.sort($(this).attr('data-sort-column'), sortMode);
                
                if(sortMode === 'ASC'){
                    sortMode = 'DESC';
                }else{
                    sortMode = 'ASC';
                }
            });
        };
        
        TableView.prototype.createHeaders = function(headers){
            var $head = $('<thead><tr></tr></thead>');
                
            // add each header title as thead item
            headers.forEach(function(header, i){
                var $header = $('<th><a href="#" title="' + header + '" data-sort-column="' + header + '">' + header + '</a></th>');
                $head.append($header);
            });
            
            return $head;
        };
        
        TableView.prototype.createRows = function(rows, isValidHighlight){
            var $body = $('<tbody></tbody>');
            
            // loop rows to create table elements
            rows.forEach(function(row, ri){
                var $row = $('<tr></tr>');
                
                // loop columns of each row
                row.forEach(function(column, ci){
                    var content = column.content;
                    
                    if(isValidHighlight(content)){
                         content = '<strong class="label yellow round">' + column.content + '</strong>';
                    }
                    
                    var $column = $('<td data-column-value="' + column.content + '" data-column="' + column.column + '">' + content + '</td>');
                    $row.append($column);
                });
                
                $body.append($row);
            });
            
            return $body;
        };
        
        
        TableView.prototype.bind = function(source, headers, isValidHighlight){
            this.source = source;
            
            // empty table items
            this.$table.empty();
                        
            // creating table title
            var $caption = $('<caption> Selected filename : ' + this.title + '</caption>');
            this.$table.append($caption);
            
            // creating table headers
            var $header = this.createHeaders(headers);
            this.$table.append($header);
            
            // creating table body
            var $body = this.createRows(source, isValidHighlight);
            this.$table.append($body);
        };
        
        TableView.prototype.sort = function(column, mode){
            var $body = this.$table.find('tbody');

            // the order is specified by the following rules
            // 1. All numbers are smaller than letters, and are ordered according to javascript order algorithm
            // 2. The letters are ordered alphabethicly, accordying to javascript order algorithm
            var $columns = $body.find('td[data-column="' + column + '"]'),
                $clone = {};
            $columns.each(function(i, $column){
                $column = $($column);
                $clone = $column.parent().clone();
                $column.parent().remove();
                
                var innerValue = $column.attr('data-column-value'),
                    nextColumn = $($columns[i + 1]),
                    nextValue = nextColumn && nextColumn.attr('data-column-value'),
                    compareResult = -1;
                
                // verify the data type
                if(innerValue === nextValue){
                    compareResult = 0;
                }else if(innerValue > nextValue){
                    compareResult = 1;
                }else{
                    compareResult = -1;
                }
                
                if(mode === "DESC" && compareResult > 0 ) compareResult = -1;
                if(mode === "DESC" && compareResult < 0 ) compareResult = 1;
                
                console.log("The value " + innerValue + " of column " + column +" is "+ compareResult + " than " + nextValue);
                
                if(compareResult < 0){
                    $clone.prependTo($body);
                }else if(compareResult > 0){
                    $clone.appendTo($body);
                }
            });

        };
        
       
        // CsvAnalizer Object
        // Allows to inspect a CSV file and get the formatted content
        // <param name='content'>Content from CSV formatted file</param>
        var CsvAnalizer = function(content){
            // regular expressions for content extracting
            this.rowSeparator = '\n';
            this.ruleValidation = /^\s*(?:'[^'\\]*(?:\\[\S\s][^'\\]*)*'|"[^"\\]*(?:\\[\S\s][^"\\]*)*"|[^,'"\s\\]*(?:\s+[^,'"\s\\]+)*)\s*(?:,\s*(?:'[^'\\]*(?:\\[\S\s][^'\\]*)*'|"[^"\\]*(?:\\[\S\s][^"\\]*)*"|[^,'"\s\\]*(?:\s+[^,'"\s\\]+)*)\s*)*$/;
            this.ruleValue = /(?!\s*$)\s*(?:'([^'\\]*(?:\\[\S\s][^'\\]*)*)'|"([^"\\]*(?:\\[\S\s][^"\\]*)*)"|([^,'"\s\\]*(?:\s+[^,'"\s\\]+)*))\s*(?:,|$)/g;
            
            this.content = content;
            
            // get all rows from content
            var rows = this.content.split(this.rowSeparator);
            
            this.headers = this.getColumnsFromRow(rows.shift());
            this.rows = rows;
            this.rows.pop(); // remove the last line ( is an empty row )
        };
        
        // Gets all columns from csv row using regular expressions for columns extracting
        // <param name='row'>content row from csv file</param>
        CsvAnalizer.prototype.getColumnsFromRow = function(row){
             // Return NULL if input string is not well formed CSV string.
            if (!this.ruleValidation.test(row)) return null;
            
            var columns = []; // Initialize array to receive values.
            
            row.replace(this.ruleValue,
                function(m0, m1, m2, m3) {
                    // Remove backslash from \' in single quoted values.
                    if (m1 !== undefined) columns.push(m1.replace(/\\'/g, "'"));
                    
                    // Remove backslash from \" in double quoted values.
                    else if (m2 !== undefined) columns.push(m2.replace(/\\"/g, '"'));
                    
                    else if (m3 !== undefined) columns.push(m3);
                    
                    return '';
                });
            
            // Handle special case of empty last value.
            if (/,\s*$/.test(row)) columns.push('');
            
            return columns;
        };
        
        // Gets file contents as a grid of elements
        CsvAnalizer.prototype.getContentAsGrid = function(){
            var self = this, grid = [];

            this.rows.forEach(function(row, ri){
                grid[ri] = [];
                
                // split each row in columns
                var columns = self.getColumnsFromRow(row);
                columns.forEach(function(column, ci){
                    column = column.trim(); // trim empty spaces of value
                    
                    grid[ri][ci] = {
                        content : column,
                        column : self.headers[ci]
                    };
                });
            });
        
            return grid;
        };
        
         
        // File selector object
        // Allows to get the contents from files selected trought input[file]
        // <param name='fileInput'>Selected file from input[file]</param>
        var FileSelector = function(fileInput){
            this.fileInput = fileInput;
        };
        
        FileSelector.prototype.getSelectedFile = function(){
            return this.fileInput.files[0];
        };
        
        FileSelector.prototype.readFileContent = function(){
            var deferred = $.Deferred(),
                promise = deferred.promise();
            
            var file = this.getSelectedFile();

            // verify if there is any selected files
            if (file) {
                
                // verify if browser support the filereader api
                if(window.FileReader){
                    var reader = new FileReader();
                    reader.readAsText(file, "UTF-8");

                    reader.onload = function (evt) {
                        // resolve the promise, with the file content as parameter
                        deferred.resolve(evt.target.result);
                    }
                    reader.onerror = function (evt) {
                        deferred.reject('Error reading the files content');
                    }
                }else{
                    deferrend.reject('Reading file not supported!');
                }
                
            }else{
                deferred.reject('There is no selected file');
            }
            
            return promise;
        };
        
        
    </script>
</body>
</html>